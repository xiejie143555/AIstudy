## 系统架构规约书

### 1. 总体架构
采用客户端-服务器架构，支持离线优先的设计理念。

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端层（Client Layer）                  │
├─────────────────────────────────────────────────────────────┤
│  Web端   │   iOS端   │   Android端   │   桌面端（Win/Mac）  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  本地存储层（Local Storage）                 │
├─────────────────────────────────────────────────────────────┤
│  SQLite数据库  │  文件系统  │  索引服务  │  缓存管理        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  同步服务层（Sync Layer）                    │
├─────────────────────────────────────────────────────────────┤
│  冲突解决  │  增量同步  │  离线队列  │  数据压缩        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  云服务层（Cloud Service）                   │
├─────────────────────────────────────────────────────────────┤
│  API网关  │  用户服务  │  存储服务  │  AI服务（可选）   │
└─────────────────────────────────────────────────────────────┘
```

### 2. 客户端架构

#### 2.1 分层设计
```
┌─────────────────────┐
│    表示层（UI）      │
├─────────────────────┤
│    业务逻辑层        │
├─────────────────────┤
│    数据访问层        │
├─────────────────────┤
│    本地存储层        │
└─────────────────────┘
```

#### 2.2 核心模块
- **记录模块**：负责内容的创建、编辑、删除
- **搜索模块**：提供全文搜索和筛选功能
- **同步模块**：处理离线同步和网络同步
- **导出模块**：支持多种格式的数据导出
- **AI模块**：可选的数字分身功能

### 3. 数据架构

#### 3.1 数据模型
```sql
-- 用户表
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP,
    settings JSON,
    encryption_key TEXT
);

-- 记录表
CREATE TABLE entries (
    id TEXT PRIMARY KEY,
    user_id TEXT,
    content TEXT,
    type TEXT,
    tags TEXT[],
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    metadata JSON,
    ai_authorized BOOLEAN DEFAULT FALSE
);

-- 标签表
CREATE TABLE tags (
    id TEXT PRIMARY KEY,
    user_id TEXT,
    name TEXT,
    color TEXT,
    usage_count INTEGER
);

-- 同步记录表
CREATE TABLE sync_log (
    id TEXT PRIMARY KEY,
    entity_type TEXT,
    entity_id TEXT,
    action TEXT,
    timestamp TIMESTAMP,
    synced BOOLEAN DEFAULT FALSE
);
```

#### 3.2 数据加密
- 用户数据使用AES-256加密
- 每个用户有独立的加密密钥
- 密钥存储在系统钥匙串中

### 4. 同步架构

#### 4.1 同步策略
- **增量同步**：只同步发生变化的数据
- **冲突解决**：最后写入者胜出（Last Write Wins）
- **离线队列**：离线操作在本地排队，网络恢复后批量同步

#### 4.2 同步流程
```
1. 检测网络状态
2. 获取本地未同步的更改
3. 发送到服务器
4. 处理服务器响应
5. 更新本地同步状态
6. 拉取服务器端的更新
7. 合并数据并解决冲突
```

### 5. AI架构（可选）

#### 5.1 隐私保护设计
- 用户授权的内容才用于AI训练
- AI模型在隔离环境中运行
- 训练数据与原始数据物理分离
- 支持用户数据的完全删除

#### 5.2 数字分身生成流程
```
1. 用户选择授权内容
2. 内容预处理和脱敏
3. 特征提取和模式识别
4. 人格模型训练
5. 对话系统配置
6. 部署为专属AI服务
```

### 6. 安全架构

#### 6.1 数据安全
- 传输加密：所有网络通信使用HTTPS/TLS
- 存储加密：本地和云端数据都进行加密
- 密钥管理：使用硬件安全模块（HSM）管理密钥

#### 6.2 隐私保护
- 零知识架构：服务端无法解密用户数据
- 最小权限原则：只收集必要的数据
- 数据生命周期管理：支持数据的完整删除

### 7. 性能优化

#### 7.1 本地性能
- 使用SQLite索引优化查询
- 实现延迟加载和分页
- 使用Web Worker处理耗时操作

#### 7.2 同步性能
- 数据压缩减少传输量
- 差异同步减少同步时间
- 断点续传处理大文件

### 8. 扩展性设计

#### 8.1 水平扩展
- 微服务架构支持独立扩展
- 无状态服务设计便于负载均衡
- CDN加速静态资源访问

#### 8.2 功能扩展
- 插件化架构支持新功能添加
- 模块化设计降低耦合度
- API版本管理保证向后兼容
