# 规约书 spec.md

## 产品需求规约书

### 1. 产品概述
"日子"是一款专注于个人日常记录的私密应用，帮助用户随手记录每天的想法、感受和活动。产品核心理念是"不要满不在乎地过日子，好像你可以活一千年似的"，鼓励用户珍惜每一天，记录生活的点滴。

### 2. 核心功能需求

#### 2.1 记录功能
- **快速记录**：支持文字、图片、语音等多种记录形式
- **智能分类**：自动识别打卡类型（运动、读书、学习等）
- **标签系统**：支持自定义标签，方便后续检索
- **模板功能**：提供常用记录模板，如日记模板、打卡模板
- **离线记录**：完全支持离线环境下的记录功能

#### 2.2 查看与检索
- **日历视图**：按日、周、月、年查看记录
- **时间轴**：线性展示所有记录
- **搜索功能**：支持全文搜索、标签搜索、时间范围搜索
- **筛选功能**：按类型、标签、情绪等维度筛选
- **统计视图**：展示打卡统计、记录频率等数据

#### 2.3 数据管理
- **本地存储**：所有数据优先存储在本地
- **云同步**：可选的云同步功能，确保多设备数据一致
- **导出功能**：支持导出为Markdown、JSON、PDF等格式
- **备份恢复**：支持定期自动备份和数据恢复
- **数据迁移**：支持从其他应用导入数据

#### 2.4 AI数字分身（可选功能）
- **内容授权**：用户可选择性授权内容用于AI训练
- **分身生成**：基于授权内容生成个人化的数字分身
- **智能对话**：与数字分身进行对话，获得个性化建议
- **隐私控制**：用户可随时查看、修改或撤销授权

### 3. 非功能性需求

#### 3.1 性能需求
- 应用启动时间 ≤ 1秒
- 记录保存响应时间 ≤ 100ms
- 搜索响应时间 ≤ 1秒
- 支持10年以上数据存储

#### 3.2 可靠性需求
- 数据丢失率为0
- 系统崩溃时不丢失正在编辑的内容
- 网络异常时不影响本地功能使用

#### 3.3 兼容性需求
- 支持iOS、Android、Web、桌面端
- 数据格式跨平台兼容
- 支持主流浏览器

#### 3.4 安全需求
- 用户数据加密存储
- 传输过程使用HTTPS
- 支持生物识别解锁
- 提供应用锁功能

---

## 用户故事规约书

### 用户画像

#### 核心用户：记录爱好者
- **年龄**：18-45岁
- **特点**：有记录习惯，注重隐私，追求效率
- **需求**：快速记录、安全存储、便捷检索

#### 次要用户：自我提升者
- **年龄**：20-40岁
- **特点**：注重个人成长，喜欢打卡和统计
- **需求**：习惯追踪、数据分析、AI建议

### 用户故事

#### 故事1：快速记录
> 作为忙碌的上班族，我希望能够在3秒内开始记录，这样我就不会错过任何灵感瞬间。

**验收标准**：
- 从点击应用到出现输入框 ≤ 2步操作
- 启动时间 ≤ 1秒
- 支持桌面快捷方式直接新建记录

#### 故事2：隐私保护
> 作为注重隐私的用户，我希望我的所有记录都只有我自己能看到，这样我才能放心地记录真实想法。

**验收标准**：
- 默认所有记录为私密状态
- 没有社交分享功能
- 数据加密存储，开发者也无法查看

#### 故事3：数据自由
> 作为长期记录者，我希望能够随时导出我的所有记录为标准格式，这样我就不担心平台关闭或数据被锁定。

**验收标准**：
- 提供一键导出功能
- 支持Markdown、JSON、PDF格式
- 导出文件人类可读，不依赖特定软件

#### 故事4：离线使用
> 作为经常出差的用户，我希望在没有网络的情况下也能正常记录，这样我在飞机上也能记录旅行见闻。

**验收标准**：
- 核心功能完全支持离线使用
- 离线期间的记录在网络恢复后自动同步
- 同步过程对用户透明

#### 故事5：AI数字分身
> 作为喜欢反思的用户，我希望能够基于我的记录生成一个AI分身，这样我就可以从旁观者的角度审视自己。

**验收标准**：
- AI功能默认关闭，需要用户主动开启
- 用户可精确控制哪些内容用于训练
- 提供内容级别的授权管理
- 支持一键删除数字分身

#### 故事6：习惯追踪
> 作为自我提升者，我希望能够追踪我的日常习惯（如运动、读书），这样我就能看到自己的成长轨迹。

**验收标准**：
- 支持自定义打卡类型
- 自动计算连续打卡天数
- 提供可视化统计图表
- 支持设置提醒

#### 故事7：快速检索
> 作为有5年记录历史的用户，我希望能够快速找到过去的某条记录，这样我就能回顾特定时期的生活。

**验收标准**：
- 支持全文搜索
- 支持按时间、标签、类型筛选
- 搜索结果在1秒内返回
- 支持高级搜索语法

---

## 系统架构规约书

### 1. 总体架构
采用客户端-服务器架构，支持离线优先的设计理念。

```
┌─────────────────────────────────────────────────────────────┐
│                    客户端层（Client Layer）                  │
├─────────────────────────────────────────────────────────────┤
│  Web端   │   iOS端   │   Android端   │   桌面端（Win/Mac）  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  本地存储层（Local Storage）                 │
├─────────────────────────────────────────────────────────────┤
│  SQLite数据库  │  文件系统  │  索引服务  │  缓存管理        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  同步服务层（Sync Layer）                    │
├─────────────────────────────────────────────────────────────┤
│  冲突解决  │  增量同步  │  离线队列  │  数据压缩        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                  云服务层（Cloud Service）                   │
├─────────────────────────────────────────────────────────────┤
│  API网关  │  用户服务  │  存储服务  │  AI服务（可选）   │
└─────────────────────────────────────────────────────────────┘
```

### 2. 客户端架构

#### 2.1 分层设计
```
┌─────────────────────┐
│    表示层（UI）      │
├─────────────────────┤
│    业务逻辑层        │
├─────────────────────┤
│    数据访问层        │
├─────────────────────┤
│    本地存储层        │
└─────────────────────┘
```

#### 2.2 核心模块
- **记录模块**：负责内容的创建、编辑、删除
- **搜索模块**：提供全文搜索和筛选功能
- **同步模块**：处理离线同步和网络同步
- **导出模块**：支持多种格式的数据导出
- **AI模块**：可选的数字分身功能

### 3. 数据架构

#### 3.1 数据模型
```sql
-- 用户表
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    created_at TIMESTAMP,
    settings JSON,
    encryption_key TEXT
);

-- 记录表
CREATE TABLE entries (
    id TEXT PRIMARY KEY,
    user_id TEXT,
    content TEXT,
    type TEXT,
    tags TEXT[],
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    metadata JSON,
    ai_authorized BOOLEAN DEFAULT FALSE
);

-- 标签表
CREATE TABLE tags (
    id TEXT PRIMARY KEY,
    user_id TEXT,
    name TEXT,
    color TEXT,
    usage_count INTEGER
);

-- 同步记录表
CREATE TABLE sync_log (
    id TEXT PRIMARY KEY,
    entity_type TEXT,
    entity_id TEXT,
    action TEXT,
    timestamp TIMESTAMP,
    synced BOOLEAN DEFAULT FALSE
);
```

#### 3.2 数据加密
- 用户数据使用AES-256加密
- 每个用户有独立的加密密钥
- 密钥存储在系统钥匙串中

### 4. 同步架构

#### 4.1 同步策略
- **增量同步**：只同步发生变化的数据
- **冲突解决**：最后写入者胜出（Last Write Wins）
- **离线队列**：离线操作在本地排队，网络恢复后批量同步

#### 4.2 同步流程
```
1. 检测网络状态
2. 获取本地未同步的更改
3. 发送到服务器
4. 处理服务器响应
5. 更新本地同步状态
6. 拉取服务器端的更新
7. 合并数据并解决冲突
```

### 5. AI架构（可选）

#### 5.1 隐私保护设计
- 用户授权的内容才用于AI训练
- AI模型在隔离环境中运行
- 训练数据与原始数据物理分离
- 支持用户数据的完全删除

#### 5.2 数字分身生成流程
```
1. 用户选择授权内容
2. 内容预处理和脱敏
3. 特征提取和模式识别
4. 人格模型训练
5. 对话系统配置
6. 部署为专属AI服务
```

### 6. 安全架构

#### 6.1 数据安全
- 传输加密：所有网络通信使用HTTPS/TLS
- 存储加密：本地和云端数据都进行加密
- 密钥管理：使用硬件安全模块（HSM）管理密钥

#### 6.2 隐私保护
- 零知识架构：服务端无法解密用户数据
- 最小权限原则：只收集必要的数据
- 数据生命周期管理：支持数据的完整删除

### 7. 性能优化

#### 7.1 本地性能
- 使用SQLite索引优化查询
- 实现延迟加载和分页
- 使用Web Worker处理耗时操作

#### 7.2 同步性能
- 数据压缩减少传输量
- 差异同步减少同步时间
- 断点续传处理大文件

### 8. 扩展性设计

#### 8.1 水平扩展
- 微服务架构支持独立扩展
- 无状态服务设计便于负载均衡
- CDN加速静态资源访问

#### 8.2 功能扩展
- 插件化架构支持新功能添加
- 模块化设计降低耦合度
- API版本管理保证向后兼容